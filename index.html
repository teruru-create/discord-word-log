<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ä¹…æœ¨æ€§ç™–è¾å…¸</title>
<link href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" rel="stylesheet">
<style>
:root {
    --bg-color: #121212;
    --text-color: #e0e0e0;
    --card-bg: linear-gradient(135deg, #1f1f1f, #2a2a2a);
    --card-border: #00ffff;
    --button-bg: #00ffff;
    --button-text: #121212;
    --highlight: #ffea00;
}
body {
    background-color: var(--bg-color);
    color: var(--text-color);
    font-family: 'Fira Code', monospace;
    padding: 30px;
    transition: background-color 0.3s, color 0.3s;
}
body.light {
    --bg-color: #f8f8f8;
    --text-color: #222222;
    --card-bg: linear-gradient(135deg, #ffffff, #e0e0e0);
    --card-border: #00bfff;
    --button-bg: #00bfff;
    --button-text: #ffffff;
    --highlight: #ffea00;
}
h1 {
    color: #00ffff;
    text-align: center;
    font-size: 3em;
    text-shadow: 0 0 10px #00ffff;
    margin-bottom: 30px;
    display: inline-block;
}
#modeToggle {
    position: absolute;
    top: 20px;
    right: 30px;
    padding: 8px 15px;
    font-size: 1em;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    background-color: var(--button-bg);
    color: var(--button-text);
    transition: 0.3s;
}
#modeToggle:hover { background-color: #00bfff; }
#controls {
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 20px;
}
input, select, button {
    padding: 10px;
    font-size: 1em;
    border-radius: 8px;
    border: none;
    outline: none;
}
input, select { background-color: #1f1f1f; color: #e0e0e0; }
body.light input, body.light select { background-color: #ffffff; color: #222222; }
button { background-color: var(--button-bg); color: var(--button-text); cursor: pointer; transition: 0.2s; }
button:hover { background-color: #00bfff; }
#log { display: flex; flex-direction: column; gap: 12px; }
.card {
    background: var(--card-bg);
    border-left: 5px solid var(--card-border);
    padding: 15px;
    border-radius: 12px;
    transition: transform 0.3s, box-shadow 0.3s, background 0.3s, border-color 0.3s;
    word-wrap: break-word;
    display: flex;
    flex-direction: column;
}
.card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,255,255,0.5); }
.alpha { color: #00bfff; }
.hiragana { color: #00ff7f; }
.katakana { color: #bf00ff; }
.highlight { background-color: var(--highlight); color: #000; }
.stats { margin-top: 20px; font-size: 1.2em; text-align: center; }
#statsChart { margin-top: 30px; max-width: 100%; }
.url-link { margin-top: 5px; font-size: 0.9em; }
</style>
</head>
<body>
<h1>â¤ä¹…æœ¨æ€§ç™–è¾å…¸â¤</h1>
<button id="modeToggle">ğŸŒ™ ãƒ€ãƒ¼ã‚¯/ãƒ›ãƒ¯ã‚¤ãƒˆåˆ‡æ›¿</button>

<div id="controls">
    <input type="text" id="searchBox" placeholder="ğŸ” æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
    <select id="dateFilter"><option value="">å…¨æ—¥ä»˜è¡¨ç¤º</option></select>
    <button id="copyBtn">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
    <button id="downloadBtn">ğŸ’¾ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
</div>

<div id="log"></div>
<div class="stats" id="stats"></div>
<canvas id="statsChart"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let originalLines = [];
let favorites = JSON.parse(localStorage.getItem('favorites')||'[]');
let showOnlyFavorites = false;

// --- ãƒ­ã‚°èª­ã¿è¾¼ã¿ ---
async function loadLog() {
    try {
        const response = await fetch('https://teruru-create.github.io/discord-word-log/output.txt');
        const text = await response.text();
        originalLines = text.trim().split('\n').map(line => {
            const dateMatch = line.match(/\d{4}\/\d{1,2}\/\d{1,2}/);
            const date = dateMatch ? dateMatch[0] : '';
            const msgText = line.replace(/\s*\|\s*\d{4}\/\d{1,2}\/\d{1,2}/, '')
                                .replace(/\s*https:\/\/discord\.com\/channels\/\d+\/\d+\/\d+/, '');
            const type = (/[A-Za-z]/.test(msgText)) ? 'alpha' :
                         (/[\u3040-\u309F]/.test(msgText) || /[\u4E00-\u9FFF]/.test(msgText)) ? 'hiragana' :
                         (/[\u30A0-\u30FF]/.test(msgText)) ? 'katakana' : 'other';
            const urlMatch = line.match(/https:\/\/discord\.com\/channels\/\d+\/\d+\/\d+/);
            const url = urlMatch ? urlMatch[0] : null;
            return { text: msgText, type, date, url };
        });

        const dates = Array.from(new Set(originalLines.map(l=>l.date).filter(d=>d)));
        const dateSelect = document.getElementById('dateFilter');
        dateSelect.innerHTML = '<option value="">å…¨æ—¥ä»˜è¡¨ç¤º</option>';
        dates.sort((a,b)=>b.localeCompare(a)).forEach(d=>{
            const opt = document.createElement('option');
            opt.value = d; opt.textContent = d;
            dateSelect.appendChild(opt);
        });

        updateDisplay();
        updateStats();
    } catch (e) {
        document.getElementById('log').innerHTML = 'ãƒ­ã‚°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
        console.error(e);
    }
}

// --- ãŠæ°—ã«å…¥ã‚Šãƒˆã‚°ãƒ« ---
function toggleFavorite(text){
    const idx = favorites.indexOf(text);
    if(idx>=0) favorites.splice(idx,1); else favorites.push(text);
    localStorage.setItem('favorites',JSON.stringify(favorites));
    updateDisplay();
}

// --- URLãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ä½œæˆ ---
function createCheckbox(url){
    const wrapper = document.createElement('div');
    wrapper.style.marginTop = '5px';
    const checkbox = document.createElement('input');
    checkbox.type='checkbox';
    checkbox.style.marginRight='5px';
    const urlSpan = document.createElement('span');
    checkbox.addEventListener('change', ()=>{
        urlSpan.innerHTML = checkbox.checked ? `<a href="${url}" target="_blank">${url}</a>` : '';
    });
    wrapper.appendChild(checkbox);
    wrapper.appendChild(urlSpan);
    return wrapper;
}

// --- è¡¨ç¤ºæ›´æ–° ---
function updateDisplay(){
    const query = document.getElementById('searchBox').value.trim();
    const dateFilter = document.getElementById('dateFilter').value;
    const logDiv = document.getElementById('log');
    logDiv.innerHTML = '';

    let displayLines = originalLines.filter(l=>{
        let pass = true;
        if(query) pass = l.text.toLowerCase().includes(query.toLowerCase());
        if(dateFilter) pass = pass && l.date === dateFilter;
        if(showOnlyFavorites) pass = pass && favorites.includes(l.text);
        return pass;
    });

    if(query){
        displayLines = displayLines.map(l=>{
            const regex = new RegExp(`(${query})`, 'gi');
            return {...l, text: l.text.replace(regex, '<span class="highlight">$1</span>')};
        });
    }

    displayLines.forEach(l=>{
        const div = document.createElement('div');
        div.className = 'card';

        // â˜…ãƒœã‚¿ãƒ³
        const star = document.createElement('span');
        star.textContent = favorites.includes(l.text) ? 'â˜…' : 'â˜†';
        star.style.cursor='pointer';
        star.style.marginRight='5px';
        star.addEventListener('click',()=>toggleFavorite(l.text));
        div.appendChild(star);

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        const msgSpan = document.createElement('span');
        msgSpan.className = l.type;
        msgSpan.innerHTML = l.text;
        div.appendChild(msgSpan);

        // URL
        if(l.url) div.appendChild(createCheckbox(l.url));

        logDiv.appendChild(div);
    });

    updateStatsChart();
}

// --- çµ±è¨ˆè¡¨ç¤º ---
function updateStats(){
    const alpha = originalLines.filter(l=>l.type==='alpha').length;
    const hira = originalLines.filter(l=>l.type==='hiragana').length;
    const kata = originalLines.filter(l=>l.type==='katakana').length;
    document.getElementById('stats').textContent =
        `ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆ: ${alpha} | ã²ã‚‰ãŒãª: ${hira} | ã‚«ã‚¿ã‚«ãƒŠ: ${kata}`;
}

// --- ã‚³ãƒ”ãƒ¼ & ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ---
document.getElementById('copyBtn').addEventListener('click', ()=>{
    const text = originalLines.map(l=>l.text.replace(/<[^>]+>/g,'')).join('\n');
    navigator.clipboard.writeText(text);
    alert('ãƒ­ã‚°ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
});
document.getElementById('downloadBtn').addEventListener('click', ()=>{
    const text = originalLines.map(l=>l.text.replace(/<[^>]+>/g,'')).join('\n');
    const blob = new Blob([text], {type:'text/plain'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'discord_log.txt';
    link.click();
});

// --- ãƒ€ãƒ¼ã‚¯/ãƒ©ã‚¤ãƒˆåˆ‡æ›¿ ---
document.getElementById('modeToggle').addEventListener('click', ()=>document.body.classList.toggle('light'));

// --- ã‚«ãƒ©ãƒ¼ãƒ†ãƒ¼ãƒ ---
const themes = {
    default:{'--bg-color':'#121212','--text-color':'#e0e0e0','--card-bg':'linear-gradient(135deg,#1f1f1f,#2a2a2a)','--card-border':'#00ffff','--button-bg':'#00ffff','--button-text':'#121212'},
    neon:{'--bg-color':'#000','--text-color':'#39ff14','--card-bg':'linear-gradient(135deg,#0f0f0f,#1f1f1f)','--card-border':'#ff00ff','--button-bg':'#ff00ff','--button-text':'#000'},
    light:{'--bg-color':'#f8f8f8','--text-color':'#222','--card-bg':'linear-gradient(135deg,#fff,#e0e0e0)','--card-border':'#00bfff','--button-bg':'#00bfff','--button-text':'#fff'}
};
function applyTheme(name){
    const theme = themes[name];
    for(const key in theme) document.documentElement.style.setProperty(key,theme[key]);
    localStorage.setItem('selectedTheme',name);
}
const savedTheme = localStorage.getItem('selectedTheme');
if(savedTheme) applyTheme(savedTheme);
const themeSelect = document.createElement('select');
themeSelect.innerHTML = Object.keys(themes).map(t=>`<option value="${t}">${t}</option>`).join('');
themeSelect.value = savedTheme||'default';
themeSelect.addEventListener('change',()=>applyTheme(themeSelect.value));
document.getElementById('controls').appendChild(themeSelect);

// --- ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºèª¿æ•´ ---
const sizeInput = document.createElement('input');
sizeInput.type='range'; sizeInput.min=12; sizeInput.max=36; sizeInput.value=16;
sizeInput.addEventListener('input',()=>{
    document.querySelectorAll('#log .card').forEach(c=>{
        c.style.fontSize = sizeInput.value+'px';
        c.style.padding = (sizeInput.value/1.2)+'px';
    });
});
document.getElementById('controls').appendChild(sizeInput);

// --- â˜…ã ã‘è¡¨ç¤ºåˆ‡æ›¿ ---
const favToggleBtn = document.createElement('button');
favToggleBtn.textContent = 'â˜…ã ã‘è¡¨ç¤º';
favToggleBtn.addEventListener('click', ()=>{
    showOnlyFavorites = !showOnlyFavorites;
    favToggleBtn.textContent = showOnlyFavorites ? 'å…¨ã¦è¡¨ç¤º' : 'â˜…ã ã‘è¡¨ç¤º';
    updateDisplay();
});
document.getElementById('controls').appendChild(favToggleBtn);

// --- çµ±è¨ˆã‚°ãƒ©ãƒ• ---
const ctx = document.getElementById('statsChart').getContext('2d');
function updateStatsChart(){
    const counts={alpha:0,hiragana:0,katakana:0}, dateCounts={};
    originalLines.forEach(l=>{
        if(counts[l.type]!==undefined) counts[l.type]++;
        if(l.date) dateCounts[l.date]=(dateCounts[l.date]||0)+1;
    });
    if(window.statsChart) window.statsChart.destroy();
    window.statsChart = new Chart(ctx,{
        type:'bar',
        data:{ labels:Object.keys(dateCounts), datasets:[{label:'æ—¥ã”ã¨ã®æŠ•ç¨¿æ•°', data:Object.values(dateCounts), backgroundColor:'#00ffff'}] },
        options:{responsive:true, plugins:{legend:{position:'top'}}, scales:{y:{beginAtZero:true}}}
    });
}

// --- åˆå›èª­ã¿è¾¼ã¿ ---
window.onload = loadLog;
setInterval(loadLog,60000);
document.getElementById('searchBox').addEventListener('input', updateDisplay);
document.getElementById('dateFilter').addEventListener('change', updateDisplay);
</script>
</body>
</html>
